<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <!--
        VISTA DE LISTA DE CITAS
        Muestra todas las citas creadas
    -->
    <record id="view_peluqueria_cita_list" model="ir.ui.view">
        <field name="name">peluqueria.cita.list</field>
        <field name="model">peluqueria.cita</field>
        <field name="arch" type="xml">
            <list>
                <field name="fecha_inicio"/>
                <field name="fecha_fin"/>
                <field name="cliente_id"/>
                <field name="estilista_id"/>
                <field name="state"/>
                <field name="total"/>
            </list>
        </field>
    </record>

    <!--
        VISTA DE FORMULARIO DE CITAS
        Permite crear y editar una cita
    -->
    <record id="view_peluqueria_cita_form" model="ir.ui.view">
        <field name="name">peluqueria.cita.form</field>
        <field name="model">peluqueria.cita</field>
        <field name="arch" type="xml">
            <form>

                <!--
                BOTONES DE ESTADO
                Se muestran u ocultan según el estado actual de la cita
                -->
                <header>

                    <!--
                        Botón Confirmar
                        Solo visible cuando la cita está en borrador
                    -->
                    <button
                        name="action_confirmar"
                        type="object"
                        string="Confirmar"
                        class="btn-primary"
                        invisible="state != 'borrador'"
                    />

                    <!--
                        Botón Finalizar
                        Solo visible cuando la cita está confirmada
                    -->
                    <button
                        name="action_realizar"
                        type="object"
                        string="Finalizar"
                        class="btn-success"
                        invisible="state != 'confirmada'"
                    />

                    <!--
                        Botón Cancelar
                        Visible en borrador o confirmada
                    -->
                    <button
                        name="action_cancelar"
                        type="object"
                        string="Cancelar"
                        class="btn-danger"
                        invisible="state not in ('borrador', 'confirmada')"
                    />

                    <!--
                        Botón Volver a borrador
                        Solo visible si la cita está cancelada
                    -->
                    <button
                        name="action_volver_borrador"
                        type="object"
                        string="Volver a borrador"
                        invisible="state in ('borrador')"
                    />

                    <!--
                        Barra visual del estado de la cita
                    -->
                    <field
                        name="state"
                        widget="statusbar"
                        statusbar_visible="borrador,confirmada,realizada,cancelada"
                    />

                </header>



                <sheet>

                    <!-- Código automático de la cita: De momento lo comento
                    porque con que aparezca una vez sobra. Ya lo he puesto en el
                    name para que sustituya lo que se mostraba antes que era el
                    identificador interno de la BBDD y eso no tiene ningún sentido -->
                    <!-- <group>
                        <field name="name" readonly="1"/>
                    </group> -->

                    <!-- Datos principales de la cita -->
                    <group>
                        <field name="cliente_id" readonly="state != 'borrador'"/>
                        <field name="estilista_id"
                        domain="[('activo', '=', True)]" readonly="state != 'borrador'"/>
                        <field name="fecha_inicio" readonly="state != 'borrador'"/>
                        <field name="fecha_fin" readonly="1"/>
                        <!-- <field name="state"/> --> 
                    </group>

                    <!-- Líneas de servicios -->
                    <notebook>
                        <page string="Servicios">
                            <field name="linea_servicio_ids" readonly="state != 'borrador'">
                                <list editable="bottom">
                                    <field name="servicio_id" width="300" domain="[('activo', '=', True)]"/>
                                    <field name="duracion"/>
                                    <field name="precio"/>
                                    <field name="subtotal" readonly="1"/>
                                </list>
                            </field>
                        </page>
                    </notebook>

                    <!-- Total de la cita -->
                    <group>
                        <field name="total" readonly="1"/>
                    </group>

                </sheet>
            </form>
        </field>
    </record>

    <!--
    VISTA CALENDARIO DE CITAS
    Muestra las citas como bloques de tiempo en una agenda
    -->
    <record id="view_peluqueria_cita_calendar" model="ir.ui.view">
        <field name="name">peluqueria.cita.calendar</field>
        <field name="model">peluqueria.cita</field>
        <field name="arch" type="xml">
            <calendar
                string="Agenda de Citas"
                date_start="fecha_inicio"
                date_stop="fecha_fin"
                color="estilista_id"
                quick_create="false">

                <!-- Título que aparece dentro del bloque -->
                <field name="name"/>

                <!-- Información adicional visible al pasar el ratón -->
                <field name="cliente_id"/>
                <field name="estilista_id"/>
                <field name="state"/>

            </calendar>
        </field>
    </record>

        <!--
        VISTA KANBAN DE CITAS
        Muestra las citas como tarjetas agrupadas por estado
    -->
    <record id="view_peluqueria_cita_kanban" model="ir.ui.view">
        <field name="name">peluqueria.cita.kanban</field>
        <field name="model">peluqueria.cita</field>
        <field name="arch" type="xml">
            <!--
                default_group_by="state" hace que las columnas se creen por estado
            -->
            <kanban default_group_by="state">
                <field name="name"/>
                <field name="cliente_id"/>
                <field name="estilista_id"/>
                <field name="fecha_inicio"/>
                <field name="fecha_fin"/>
                <field name="state"/>
                <field name="total"/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click oe_kanban_card">

                            <!-- Cabecera de la tarjeta -->
                            <div class="oe_kanban_details">
                                <!-- Código de la cita -->
                                <strong>
                                    <field name="name"/>
                                </strong>
                            </div>

                            <!-- Información principal -->
                            <div class="oe_kanban_details">
                                <!-- Cliente y estilista -->
                                <div>
                                    <span>Cliente: </span>
                                    <field name="cliente_id"/>
                                </div>
                                <div>
                                    <span>Estilista: </span>
                                    <field name="estilista_id"/>
                                </div>
                            </div>

                            <!-- Fechas -->
                            <div class="oe_kanban_details">
                                <div>
                                    <span>Inicio: </span>
                                    <field name="fecha_inicio"/>
                                </div>
                                <div>
                                    <span>Fin: </span>
                                    <field name="fecha_fin"/>
                                </div>
                            </div>

                            <!-- Estado y total -->
                            <div class="oe_kanban_details">
                                <div>
                                    <span>Estado: </span>
                                    <field name="state"/>
                                </div>
                                <div>
                                    <span>Total: </span>
                                    <field name="total"/>
                                </div>
                            </div>

                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!--
    VISTA DE BÚSQUEDA DE CITAS
    Define filtros que el usuario puede activar o desactivar
    -->
    <record id="view_peluqueria_cita_search" model="ir.ui.view">
        <field name="name">peluqueria.cita.search</field>
        <field name="model">peluqueria.cita</field>
        <field name="arch" type="xml">
            <search>

                <!-- Filtro: citas desde hoy en adelante -->
                <filter
                    name="futuras"
                    string="Citas futuras"
                    domain="[('fecha_inicio', '>=', context_today())]"
                />

                <!-- Filtro: citas de hoy -->
                <filter
                    name="hoy"
                    string="Hoy"
                    domain="[
                        ('fecha_inicio', '&gt;=', context_today()),
                        ('fecha_inicio', '&lt;', (context_today() + relativedelta(days=1)))
                    ]"
                />

                <!-- Filtro por estado -->
                <filter name="borrador" string="Borrador" domain="[('state','=','borrador')]"/>
                <filter name="confirmada" string="Confirmada" domain="[('state','=','confirmada')]"/>

                <!-- Campos de búsqueda -->
                <field name="name"/>
                <field name="cliente_id"/>
                <field name="estilista_id"/>

            </search>
        </field>
    </record>



    <!--
        ACCIÓN DE CITAS
        Es la que usa el menú Gestiones - Citas
    -->
    <record id="action_peluqueria_cita" model="ir.actions.act_window">
        <field name="name">Citas</field>
        <field name="res_model">peluqueria.cita</field>
        <field name="view_mode">calendar,kanban,list,form</field>

        <!--
            Hacemos que, al abrir la acción, las citas se agrupen por estado
            también en otras vistas (especialmente kanban)
        -->
        <!-- Además utilizamos la vista search_default_futuras para poner filtros por defecto -->
        <field name="context">{
            'group_by': 'state',
            'view_peluqueria_cita_search': 1,
            'search_default_futuras': 1
            }</field>
    </record>

</odoo>
